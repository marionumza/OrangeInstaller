#encoding: utf-8
from OpenOrange import *
from Report import Report
from GlobalTools import *

ParentChequeBounceWindow = SuperClass("ChequeBounceWindow","FinancialTransWindow",__file__)
class ChequeBounceWindow(ParentChequeBounceWindow):

    def afterEdit(self, fieldname):
        ParentChequeBounceWindow.afterEdit(self, fieldname)     
        if (fieldname == "ChequeNr"):
            res = self.getRecord().pasteChequeNr()
            if not res:
                message(tr("No existe un cheque con ese numero"))
        
    def afterDeleteRow(self, fieldname, rownr):
        self.getRecord().sumUp()

    def filterPasteWindow(self,fieldname):
        record = self.getRecord()
        if (fieldname == "ChequeNr"):
           from Cheque import Cheque
           if (record.OperationType==0):
                filter = "{Status} = i|%s|" % Cheque.DEPOSITED # depositado
           elif (record.OperationType==1):
                filter = "{Status} = i|%s|" % Cheque.INPORTFOLIO # en cartera 
           elif (record.OperationType==2):
                filter = "( {Status} = i|%s| OR {Status} = i|%s| )" % (Cheque.ENDORSED, Cheque.SOLD) # endosado 
           if record.Office:
                filter += " AND {Office} = s|%s| " % record.Office
           return filter

    def genDebitNote(self):
        record = self.getRecord()
        if (record.isNew() or record.isModified()):
            message(tr("REGISTERNOTSAVED"))
            return
        if (not record.confirmed()):
            message(tr("REGISTERNOTAPPROVED"))
            return
        dnote = record.genDebitNote()
        if (dnote):
            dnote.openInWindow()

    def showDebitNotes(self):
        record = self.getRecord()
        from Invoice import Invoice
        inv = Invoice()
        inv.OriginType = inv.Origin[record.name()]
        inv.OriginNr = record.SerNr
        if (inv.load()):
            inv.openInWindow()
            
    def genReceipt(self):
        receipt = self.getRecord().genReceipt()
        if receipt:
            receipt.openInWindow()
        else:
            message(receipt)
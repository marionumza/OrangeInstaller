#encoding: utf-8
from OpenOrange import *
import ListViewItem
from Mail import Mail
__author__ = 'PDB'

class MailItem(ListViewItem.ListViewItem):
                
    def selected(self):
        from MailWindow import MailWindow
        wnd = MailWindow()
        mail = Mail()
        mail.Id = self.id
        if mail.load():
            wnd.setRecord(mail)
            wnd.open()

class LabelItem(ListViewItem.ListViewItem):
                
    def selected(self):
        self.window.fillMailsList(self.Code)
        
ParentMailInboxWindow = SuperClass("MailInboxWindow","Window",__file__)
class MailInboxWindow(ParentMailInboxWindow):
    
    def afterShowRecord(self):
        ParentMailInboxWindow.afterShowRecord(self)
        self.fillLabelsList()
        self.fillMailsList()
        
    def fillMailsList(self, label=None):
        mails = Query()
        mails.sql = "SELECT * FROM [Mail]\n"
        mails.sql += "WHERE?AND {User}=s|%s|\n" % currentUser()
        if label: mails.sql += "WHERE?AND {Label}=s|%s|\n" % label
        mails.sql += "ORDER BY {TransDate} DESC, {TransTime} DESC\n"

        listview = self.getListView("Mails")
        listview.setColumns(("From", "To", "Subject", "Date", "Time"))
        if mails.open():
            for rec in mails:
                item = MailItem(listview)
                item.setText((rec.MailFrom, rec.MailTo, rec.Subject, rec.TransDate, rec.TransTime))
                item.id = rec.Id

    
    def fillLabelsList(self):
        from Label import Label
        labels = Label.makeDictionary("Name")
        listview = self.getListView("Labels")
        listview.setColumns(("",))
        if labels:
            for label in labels:
                item = LabelItem(listview)
                item.setText((labels[label],))
                item.Code = label
                item.window = self    
    
    def afterEdit(self, fieldname):
        ParentMailInboxWindow.afterEdit(self, fieldname)
        if fieldname == "PersonCode":
            from Person import Person
            p = Person.bring(self.getRecord().PersonCode)
            if p:
                listview = self.getListView("MyListView")
                item = MailInboxItem(listview)
                item.setText((p.Name, p.LastName, p.Address))

    def buttonClicked(self, buttonname):
        if buttonname == "newMail":
            from MailWindow import MailWindow
            mail = Mail()
            mail.defaults()
            wnd = MailWindow()
            wnd.setRecord(mail)
            wnd.open()